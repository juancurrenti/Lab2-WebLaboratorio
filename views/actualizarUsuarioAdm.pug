extends layout

block content
  head
    title Actualizar Usuario

  div.container.margin-top-custom
    h1 Actualizar Usuario

    if mensajeExito
      div.alert.alert-success(role="alert") #{mensajeExito}
    if mensajeError
      div.alert.alert-danger(role="alert") #{mensajeError}

    .form-group
      label(for="busquedaUsuario") Buscar Usuario por Nombre o Correo:
      input(type="text" id="busquedaUsuario" class="form-control" onkeyup="buscarUsuariosTiempoReal()" placeholder="Escriba nombre o correo..." autocomplete="off")
      ul#resultadosBusqueda(class="list-group mt-2")

    form#actualizar-usuario-form(action="/admin/actualizar-usuario" method="POST")
      input(type="hidden" name="idUsuario" id="idUsuario") 
      .form-group
        label(for="nombre") Nombre:
        input(type="text" name="nombre" id="nombre" class="form-control" required)
      .form-group
        label(for="correo_electronico") Correo Electrónico:
        input(type="email" name="correo_electronico" id="correoElectronico" class="form-control" required)
      .form-group
        label(for="password") Contraseña (dejar en blanco para no cambiar):
        input(type="password" name="password" id="password" class="form-control")
      .form-group
        label(for="rol") Rol:
        select(name="rol" id="rol" class="form-control")
          option(value="recepcionista") Recepcionista
          option(value="tecnico") Técnico
          option(value="bioquimico") Bioquímico
          option(value="admin") Administrador
      

      .form-group.mt-4
        button(type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmUpdateModal") Actualizar Usuario
        button(type="button" onclick="eliminarUsuario()" class="btn btn-danger ms-2") Eliminar Usuario
        a.btn.btn-secondary.ms-2(href="javascript:history.back()") Volver

    div#mensaje

  .modal.fade#confirmUpdateModal(tabindex="-1" aria-labelledby="modalLabelUpdate" aria-hidden="true")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title#modalLabelUpdate ¿Confirmar Actualización?
          button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
        .modal-body
          p ¿Estás seguro de que deseas actualizar los datos de este usuario?
        .modal-footer
          button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
          button.btn.btn-success#confirmSubmitUpdateBtn(type="button") Confirmar

  script.
    function buscarUsuariosTiempoReal() {
      const busqueda = document.getElementById("busquedaUsuario").value;
      if (!busqueda) {
        document.getElementById("resultadosBusqueda").innerHTML = "";
        return;
      }
      fetch(`/admin/actualizarUsuarioAdm?nombre=${busqueda}`)
        .then(response => response.json())
        .then(data => {
          const resultados = document.getElementById("resultadosBusqueda");
          resultados.innerHTML = "";
          if (data.usuarios && data.usuarios.length > 0) {
            data.usuarios.forEach(usuario => {
              const li = document.createElement("li");
              li.className = "list-group-item list-group-item-action";
              li.textContent = `${usuario.nombre_usuario} (${usuario.correo_electronico}) - ${usuario.rol}`;
              li.onclick = () => seleccionarUsuario(usuario);
              resultados.appendChild(li);
            });
          } else {
            resultados.innerHTML = '<li class="list-group-item">No se encontraron usuarios</li>';
          }
        })
        .catch(error => {
          console.error("Error en la búsqueda:", error);
        });
    }

    function seleccionarUsuario(usuario) {
      document.getElementById("idUsuario").value = usuario.id_Usuario;
      document.getElementById("nombre").value = usuario.nombre_usuario;
      document.getElementById("correoElectronico").value = usuario.correo_electronico;
      document.getElementById("rol").value = usuario.rol;
      document.getElementById("resultadosBusqueda").innerHTML = "";
    }

    function eliminarUsuario() {
      const idUsuario = document.getElementById("idUsuario").value;
      if (!idUsuario) {
        document.getElementById("mensaje").innerHTML = '<div class="alert alert-warning">Debe seleccionar un usuario para eliminar.</div>';
        return;
      }
      if (confirm("¿Estás seguro de que deseas eliminar este usuario? Esta acción es irreversible.")) {
        fetch(`/admin/eliminarUsuarioAdm/${idUsuario}`, {
          method: "DELETE",
        })
          .then(response => response.json())
          .then(data => {
            if (data.mensaje) {
              document.getElementById("mensaje").innerHTML = `<div class="alert alert-success">${data.mensaje}</div>`;
              document.getElementById('idUsuario').value = "";
              document.getElementById('nombre').value = "";
              document.getElementById("correoElectronico").value = "";
              document.getElementById("rol").value = "";
              document.getElementById("password").value = "";
            } else {
              document.getElementById("mensaje").innerHTML = `<div class="alert alert-danger">${data.error || 'Usuario no encontrado'}</div>`;
            }
          })
          .catch(error => {
            console.error("Error al eliminar el usuario:", error);
            document.getElementById("mensaje").innerHTML = '<div class="alert alert-danger">Error al eliminar el usuario.</div>';
          });
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const confirmSubmitBtn = document.querySelector('#confirmSubmitUpdateBtn');
      const form = document.querySelector('#actualizar-usuario-form');
      if (confirmSubmitBtn) {
        confirmSubmitBtn.addEventListener('click', function() {
          form.submit();
        });
      }
    });